#!/usr/bin/env sh
# This script is part of Martin V\"ath's archwrap project.
set -u
l=xz
case ${0##*/} in
*lz*)
	l=lzma;;
esac

CalcXz() {
	xz_opt='--best'
	m=`free|LC_ALL=C sed -ne 's/Mem: *\([0-9]*\).*/\1/p'` \
		&& [ -n "${m:++}" ] || return
	[ "$m" -gt 1800000 ] && return
	if [ "$m" -gt 950000 ]
	then	xz_opt='-8'
	elif [ "$m" -gt 400000 ]
	then	xz_opt='-7'
	else	xz_opt='-6'
	fi
}

if [ -n "${XZ_OPT++}" ]
then	xz_opt=$XZ_OPT
	unset XZ_OPT
else	CalcXz
fi
exec "$l" --extreme $xz_opt ${1+"$@"}
