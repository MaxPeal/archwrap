#!/usr/bin/env sh
# This script is part of Martin V\"ath's archwrap project.
set -u
case ${0##*/} in
*xz*)	xzmode=:;;
*lz*)	xzmode=false;;
*)	xzmode=:;;
esac

which=`command -v which` || which=
MakeExternal() {
	[ "$which" = 'which' ] && eval $1=\`which $2\` \
		|| eval $1=\`command -v $2\` || eval $1=
	eval ": \${$1:=$2}"
}

CalcXz() {
	xz_opt='--best'
	m=`free|LC_ALL=C sed -ne 's/Mem: *\([0-9]*\).*/\1/p'` \
		&& [ -n "${m:++}" ] || return
	[ "$m" -gt 1800000 ] && return
	if [ "$m" -gt 950000 ]
	then	xz_opt='-8'
	elif [ "$m" -gt 400000 ]
	then	xz_opt='-7'
	else	xz_opt='-6'
	fi
}

Remove() {
	n=
	for i in $xz_opt
	do	r=$i
		for j
		do	case $i in
			$j)
				r=
				break;;
			esac
		done
		[ -z "${r:++}" ] && continue
		[ -z "${n:++}" ] && n=$r || n="$n $r"
	done
	xz_opt=$n
}

xz_opt=$XZ_OPT
if [ -z "${xz_opt:++}" ]
then	CalcXz
else	Remove '--extreme'
fi
export XZ_OPT='--extreme'
if $xzmode
then	MakeExternal l xz
else	MakeExternal l lzma
fi
exec "$l" $xz_opt "$@"
