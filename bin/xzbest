#!/usr/bin/env sh
# This script is part of Martin V\"ath's archwrap project.
set -u
l=xz
case ${0##*/} in
*lz*)
	l=lzma;;
esac

CalcXz() {
	xz_opt='-9e'
	m=`free|LC_ALL=C sed -ne 's/Mem: *\([0-9]*\).*/\1/p'` \
		&& [ -n "${m:++}" ] || return
	[ "$m" -gt 1800000 ] && return
	if [ "$m" -gt 950000 ]
	then	xz_opt='-8e'
	elif [ "$m" -gt 400000 ]
	then	xz_opt='-7e'
	else	xz_opt='-6e'
	fi
}

case ${XZ_OPT:-n} in
*[!-0123456789abcdefghijklmnopqrstuvwxyz]*)
	xz_opt='-e '${XZ_OPT};;
-[!-]*)
	xz_opt=${XZ_OPT}e;;
*)
	CalcXz;;
esac
unset XZ_OPT
exec "$l" ${xz_opt} ${1+"$@"}
